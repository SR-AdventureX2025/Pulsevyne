# 订阅消息模板配置指南

## 问题描述

如果您遇到以下错误：
```
请求订阅消息权限失败: {errMsg: "requestSubscribeMessage:fail No template data return, verify the template id exist", errCode: 20001}
```

这表示订阅消息模板未正确配置或模板ID不存在。

## 解决方案

### 1. 登录微信公众平台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用小程序管理员账号登录
3. 选择对应的小程序

### 2. 配置订阅消息模板

1. **进入订阅消息管理**
   - 左侧菜单：功能 → 订阅消息
   - 或直接访问：开发管理 → 订阅消息

2. **添加消息模板**
   - 点击「选用」按钮
   - 在模板库中搜索适合的模板
   - 或者申请新的模板

3. **推荐的模板类型**
   ```
   模板标题：任务提醒
   模板内容：
   {{thing1.DATA}} - 事项主题
   {{thing2.DATA}} - 事项名称  
   {{phrase3.DATA}} - 任务状态
   {{time4.DATA}} - 提醒时间
   ```

### 3. 获取正确的模板ID

1. **查看模板列表**
   - 在订阅消息页面查看已添加的模板
   - 找到对应的模板ID（形如：`xxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`）

2. **复制模板ID**
   - 点击模板详情
   - 复制完整的模板ID

### 4. 更新代码中的模板ID

1. **修改 `utils/reminderManager.js`**
   ```javascript
   constructor() {
     // 将此处的模板ID替换为您的正确模板ID
     this.templateId = '您的正确模板ID'
     this.reminderKey = 'action_reminders'
   }
   ```

2. **修改 `app.js`**
   ```javascript
   // 在 requestNotificationPermission 方法中
   wx.requestSubscribeMessage({
     tmplIds: ['您的正确模板ID'], // 替换为正确的模板ID
     // ...
   });
   ```

### 5. 验证配置

1. **检查模板状态**
   - 确保模板状态为「正常」
   - 如果状态为「待审核」，需要等待审核通过

2. **测试功能**
   - 重新编译小程序
   - 测试订阅消息权限请求
   - 查看控制台是否还有错误

## 常见问题

### Q1: 找不到合适的模板怎么办？

**A1**: 可以申请自定义模板
1. 在订阅消息页面点击「申请模板」
2. 填写模板标题和内容
3. 等待微信审核（通常1-3个工作日）

### Q2: 模板审核不通过怎么办？

**A2**: 检查模板内容是否符合规范
1. 避免营销性质的内容
2. 确保内容与小程序功能相关
3. 参考微信官方的模板规范

### Q3: 模板ID格式是什么样的？

**A3**: 正确的模板ID格式示例
```
正确格式：abc123def-456g-789h-012i-jklmnopqrstu
错误格式：fOnlSnJzLlzrTMbxx-aRum2vuSxaItxjljp6oXs-w6c（这是示例ID）
```

### Q4: 开发环境和生产环境需要不同的模板ID吗？

**A4**: 是的
- 开发环境：使用测试小程序的模板ID
- 生产环境：使用正式小程序的模板ID
- 建议在配置文件中分别设置

## 最佳实践

### 1. 环境配置

创建配置文件 `config/template.js`：
```javascript
// 根据环境选择不同的模板ID
const templateConfig = {
  development: {
    templateId: '开发环境模板ID'
  },
  production: {
    templateId: '生产环境模板ID'
  }
}

const env = __wxConfig.envVersion || 'production'
module.exports = templateConfig[env]
```

### 2. 错误处理

在代码中添加完善的错误处理：
```javascript
wx.requestSubscribeMessage({
  tmplIds: [templateId],
  success: (res) => {
    // 处理成功情况
  },
  fail: (error) => {
    if (error.errCode === 20001) {
      // 模板ID不存在
      console.error('模板ID配置错误，请检查微信公众平台设置')
    }
    // 其他错误处理
  }
})
```

### 3. 用户体验优化

- 提供清晰的错误提示
- 允许用户稍后重新授权
- 在设置页面提供权限管理入口

## 联系支持

如果按照以上步骤仍无法解决问题，请：

1. 检查微信开发者工具版本是否最新
2. 确认小程序基础库版本支持订阅消息
3. 查看微信官方文档的最新更新
4. 联系微信客服或在开发者社区求助

---

**注意**：订阅消息功能需要小程序在微信环境中运行，开发者工具中可能无法完全模拟真实效果。建议在真机上进行测试。